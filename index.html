<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level Up! - Sua Jornada de Dev</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        .font-game { font-family: 'Press Start 2P', cursive; }
        .glass-effect { background: rgba(45, 55, 72, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #4a5568; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #718096; }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 40; display: flex; align-items: center; justify-content: center; }
        .modal-content { z-index: 50; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        @keyframes levelUpAnimation {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px 15px rgba(56, 189, 248, 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(56, 189, 248, 0); }
        }
        .level-up { animation: levelUpAnimation 1.8s ease-in-out; }
        .teacher-tab.active { border-color: #22d3ee; color: #22d3ee; }
        .teacher-tab:not(.active) { border-color: transparent; color: #9ca3af; }
        .teacher-tab:hover:not(.active) { color: #e5e7eb; border-color: #4b5563; }
        .teacher-tab-content { display: none; }
        .teacher-tab-content.active { display: block; }

        /* Podium Styles */
        .podium-item { transition: transform 0.3s ease-in-out; }
        .podium-item:hover { transform: translateY(-10px); }
        .podium-1 { border-color: #FFD700; box-shadow: 0 0 20px #FFD700; }
        .podium-2 { border-color: #C0C0C0; box-shadow: 0 0 15px #C0C0C0; }
        .podium-3 { border-color: #CD7F32; box-shadow: 0 0 10px #CD7F32; }
        .podium-other { border-color: #4A5568; }
        .podium-rank {
            position: absolute;
            top: -15px;
            left: -15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
        }
        .epic-highlight {
            border: 2px solid #a855f7; /* purple-500 */
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.5);
        }
    </style>
</head>
<body class="min-h-screen p-4 flex items-center justify-center">

    <!-- Loading Spinner -->
    <div id="loading-spinner" style="display: flex;" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex-col items-center justify-center z-[100]">
        <div class="font-game text-2xl text-cyan-400 mb-4">Carregando Jogo...</div>
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-cyan-500"></div>
    </div>
    
    <!-- App Container -->
    <div id="app-container" class="w-full max-w-7xl mx-auto">
        <!-- Views will be rendered here by JavaScript -->
    </div>
    
    <!-- Modals (will be populated by JS) -->
    <div id="modal-container"></div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, getDocs, query, where, updateDoc, onSnapshot, deleteDoc, writeBatch, serverTimestamp, orderBy, increment, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- IMPORTANT: PASTE YOUR FIREBASE CONFIGURATION HERE ---
        const firebaseConfig = {
  apiKey: "AIzaSyDv0qbKmHe3CKNMez7A1YyBN4ZXWhNqaXo",
  authDomain: "portal-de-notas-gamificado.firebaseapp.com",
  projectId: "portal-de-notas-gamificado",
  storageBucket: "portal-de-notas-gamificado.firebasestorage.app",
  messagingSenderId: "379073119299",
  appId: "1:379073119299:web:d9655747ce1d865a3fc0f6",
  measurementId: "G-HM5WXQ13FW"
        };
        // ---------------------------------------------------------

        // --- Initialize Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- App State ---
        let currentTeacher = null;
        let unsubscribeListeners = [];
        const appContainer = document.getElementById('app-container');
        const modalContainer = document.getElementById('modal-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- Utility Functions ---
        function showView(viewHTML) {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            appContainer.innerHTML = viewHTML;
            loadingSpinner.style.display = 'none';
        }

        function showModal(modalHTML) {
            modalContainer.innerHTML = modalHTML;
        }

        function hideModal() {
            modalContainer.innerHTML = '';
        }

        function showAlert(message, type = 'info') {
            const color = type === 'error' ? 'red' : 'cyan';
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl text-center border border-${color}-500">
                        <p class="mb-6">${message}</p>
                        <button class="modal-close-btn bg-${color}-500 hover:bg-${color}-600 text-gray-900 font-bold py-2 px-6 rounded-lg">OK</button>
                    </div>
                </div>`;
            showModal(modalHTML);
        }
        
        // --- Event Delegation ---
        document.body.addEventListener('click', handleClick);
        document.body.addEventListener('submit', handleSubmit);
        document.body.addEventListener('change', handleChange);

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, async (user) => {
            try {
                if (user) {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        currentTeacher = { uid: user.uid, ...userData };
                        if (userData.role === 'admin') await renderAdminDashboard();
                        else if (userData.role === 'teacher') await renderTeacherDashboard();
                        else await renderLoginView(); // Fallback for unknown roles
                    } else {
                        await signOut(auth); // User exists in Auth but not in Firestore
                    }
                } else {
                    currentTeacher = null;
                    await renderLoginView();
                }
            } catch (error) {
                console.error("Authentication state change error:", error);
                await renderLoginView(); // Render login on error
            } finally {
                loadingSpinner.style.display = 'none';
            }
        });

        // --- TOP-LEVEL EVENT HANDLERS ---
        async function handleClick(e) {
            const target = e.target.closest('a, button');
            if (!target) return;

            if (target.closest('.modal-close-btn') || e.target.classList.contains('modal-backdrop')) {
                hideModal();
                return;
            }

            const isSubmit = target.type === 'submit';

            const actionMap = {
                'show-register-link': renderRegisterView,
                'show-login-link': renderLoginView,
                'logout-btn': () => signOut(auth),
                'login-student-btn': handleStudentLogin,
                'search-student-btn': handleStudentSearch,
                'add-student-btn': () => handleStudentModal(),
                'import-students-btn': handleImportStudentModal,
                'edit-student-btn': () => handleStudentModal(target.dataset.id),
                'delete-student-btn': () => handleDeleteStudent(target.dataset.id),
                'add-quest-btn': () => handleQuestModal(),
                'import-quests-btn': handleImportQuestModal,
                'edit-quest-btn': () => handleQuestModal(target.dataset.id),
                'delete-quest-btn': () => handleDeleteQuest(target.dataset.id),
                'grade-quest-btn': () => handleGradingModal(target.dataset.id),
                'import-grades-btn': () => handleImportGradesModal(target.dataset.questId),
                'add-epic-work-btn': () => handleEpicWorkModal(),
                'edit-epic-work-btn': () => handleEpicWorkModal(target.dataset.id),
                'delete-epic-work-btn': () => handleDeleteEpicWork(target.dataset.id),
                'approve-btn': () => handleTeacherApproval(target.dataset.id, true),
                'reject-btn': () => handleTeacherApproval(target.dataset.id, false),
                'show-past-results-btn': () => handleStudentPastResultsModal(target.dataset.studentId),
                'add-past-result-btn': () => handlePastResultModal(null, target.dataset.studentId),
                'import-past-results-btn': handleImportPastResultsModal,
                'edit-past-result-btn': () => handlePastResultModal(target.dataset.id),
                'delete-past-result-btn': () => handleDeletePastResult(target.dataset.id),
            };

            const actionKey = Object.keys(actionMap).find(key => target.id === key || target.classList.contains(key));
            
            if (actionKey) {
                if (!isSubmit) e.preventDefault();
                actionMap[actionKey]();
            } else if (target.classList.contains('teacher-tab')) {
                e.preventDefault();
                handleTabSwitch(target);
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const target = e.target;
            if (target.id === 'teacher-login-form') handleTeacherLogin(target);
            if (target.id === 'teacher-register-form') handleTeacherRegister(target);
            if (target.id === 'student-form') handleStudentFormSubmit(target);
            if (target.id === 'quest-form') handleQuestFormSubmit(target);
            if (target.id === 'message-form') handleMessageFormSubmit(target);
            if (target.id === 'grading-form') handleGradingFormSubmit(target);
            if (target.id === 'import-student-form') handleStudentImport(target);
            if (target.id === 'import-quest-form') handleQuestImport(target);
            if (target.id === 'epic-work-form') handleEpicWorkFormSubmit(target);
            if (target.id === 'import-grades-form') handleGradeImport(target);
            if (target.id === 'past-result-form') handlePastResultFormSubmit(target);
            if (target.id === 'import-past-results-form') handlePastResultImport(target);
        }

        function handleChange(e) {
            const target = e.target;
            if (target.id === 'leaderboard-filter') {
                const studentId = target.dataset.studentId;
                renderStudentLeaderboard(target.value, studentId);
            }
             if (target.name === 'message-type') {
                const container = document.getElementById('student-select-container');
                if (container) {
                    container.style.display = e.target.value === 'personal' ? 'block' : 'none';
                }
            }
            if (target.id === 'epic-quest-select') {
                populateEpicStudentsSelect(target.value);
            }
        }
        
        // --- HANDLER IMPLEMENTATIONS ---
        
        async function handleTeacherLogin(form) {
             const email = form.querySelector('#teacher-email').value;
             const password = form.querySelector('#teacher-password').value;
             if (!email || !password) return showAlert('Por favor, preencha todos os campos.', 'error');
             try { await signInWithEmailAndPassword(auth, email, password); } 
             catch (error) { showAlert(`Erro no login: ${error.message}`, 'error'); }
        }

        async function handleTeacherRegister(form) {
            const name = form.querySelector('#register-name').value;
            const email = form.querySelector('#register-email').value;
            const password = form.querySelector('#register-password').value;
            if (!name || !email || !password) return showAlert('Por favor, preencha todos os campos.', 'error');
            if (password.length < 6) return showAlert('A senha deve ter no mínimo 6 caracteres.', 'error');

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, "users", cred.user.uid), { name, email, role: 'teacher', status: 'pending' });
                showAlert('Solicitação de cadastro enviada com sucesso! Aguarde a aprovação.');
                renderLoginView();
            } catch (error) { showAlert(`Erro ao registrar: ${error.message}`, 'error'); }
        }

        async function handleStudentLogin() {
            const studentMatricula = document.getElementById('student-id-input').value.trim();
            if (!studentMatricula) return showAlert('Por favor, insira sua matrícula.', 'error');
            
            loadingSpinner.style.display = 'flex';
            const q = query(collection(db, "students"), where("matricula", "==", studentMatricula));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                loadingSpinner.style.display = 'none';
                return showAlert('Matrícula não encontrada.', 'error');
            }
            
            const studentDoc = snapshot.docs[0];
            await renderStudentDashboard(studentDoc.id, studentDoc.data());
        }

        async function handleStudentSearch() {
            const name = document.getElementById('student-name-search').value.trim();
            const resultDiv = document.getElementById('student-search-result');
            if(!name) return resultDiv.textContent = 'Por favor, digite um nome.';
            
            resultDiv.textContent = 'Buscando...';
            const q = query(collection(db, "students"), where("name", "==", name));
            const snapshot = await getDocs(q);
            if(snapshot.empty) {
                resultDiv.textContent = 'Nenhum aluno encontrado com esse nome.';
            } else {
                const matricula = snapshot.docs[0].data().matricula;
                resultDiv.textContent = `Matrícula encontrada: ${matricula}`;
            }
        }

        async function handleTeacherApproval(teacherId, approve) {
            const status = approve ? 'approved' : 'rejected';
            await updateDoc(doc(db, "users", teacherId), { status });
            showAlert(`Mestre ${approve ? 'aprovado' : 'rejeitado'}!`);
        }

        function handleTabSwitch(tabElement) {
            document.querySelectorAll('.teacher-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.teacher-tab-content').forEach(content => content.classList.remove('active'));

            tabElement.classList.add('active');
            const tabName = tabElement.dataset.tab;
            const contentEl = document.getElementById(`tab-content-${tabName}`);
            contentEl.classList.add('active');

            if (contentEl.innerHTML.trim() === '') {
                if (tabName === 'students') renderStudentsTab();
                if (tabName === 'quests') renderQuestsTab();
                if (tabName === 'messages') renderMessagesTab();
                if (tabName === 'epic-works') renderEpicWorksTab();
                if (tabName === 'past-results') renderPastResultsTab();
            }
        }
        
        async function handleStudentFormSubmit(form) {
            const id = form.dataset.id;
            const studentData = {
                name: form.querySelector('#student-name').value,
                matricula: form.querySelector('#student-matricula').value,
                turma: form.querySelector('#student-turma').value.trim(),
                teacherId: currentTeacher.uid
            };
            if(!studentData.name || !studentData.matricula || !studentData.turma) return showAlert('Preencha todos os campos.', 'error');

            try {
                if (id) {
                    await updateDoc(doc(db, "students", id), studentData);
                    showAlert('Dev atualizado com sucesso!');
                } else {
                    await addDoc(collection(db, "students"), { ...studentData, totalXP: 0, lastSeenXP: 0 });
                    showAlert('Novo Dev adicionado!');
                }
                hideModal();
            } catch (error) { showAlert(`Erro ao salvar: ${error.message}`, 'error'); }
        }
        
        async function handleDeleteStudent(studentId) {
            if (!window.confirm('Tem certeza que deseja remover este Dev? Todas as suas notas e resultados serão perdidos.')) return;
            try {
                const q = query(collection(db, "pastResults"), where("studentId", "==", studentId));
                const snapshot = await getDocs(q);
                const batch = writeBatch(db);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();

                await deleteDoc(doc(db, "students", studentId));
                showAlert('Dev removido com sucesso.');
            } catch (error) { showAlert(`Erro ao remover: ${error.message}`, 'error'); }
        }

        async function handleQuestFormSubmit(form) {
            const id = form.dataset.id;
            const questData = {
                title: form.querySelector('#quest-title').value,
                description: form.querySelector('#quest-description').value,
                difficulty: form.querySelector('#quest-difficulty').value,
                maxXp: parseInt(form.querySelector('#quest-xp').value, 10),
                turmas: form.querySelector('#quest-turmas').value.split(',').map(t => t.trim()).filter(Boolean),
                endDate: Timestamp.fromDate(new Date(form.querySelector('#quest-end-date').value.replace(/-/g, '\/'))),
                teacherId: currentTeacher.uid
            };

            if(!questData.title || !questData.maxXp || !questData.turmas.length || !form.querySelector('#quest-end-date').value) {
                return showAlert('Preencha todos os campos obrigatórios.', 'error');
            }
            
            try {
                if (id) {
                    await updateDoc(doc(db, "quests", id), questData);
                    showAlert('Quest atualizada com sucesso!');
                } else {
                    await addDoc(collection(db, "quests"), questData);
                    showAlert('Nova Quest criada!');
                }
                hideModal();
            } catch(error) { showAlert(`Erro ao salvar a Quest: ${error.message}`, 'error'); }
        }

        async function handleDeleteQuest(questId) {
            if (!window.confirm('Tem certeza que deseja remover esta Quest?')) return;
            try {
                await deleteDoc(doc(db, "quests", questId));
                showAlert('Quest removida com sucesso.');
            } catch (error) { showAlert(`Erro ao remover a Quest: ${error.message}`, 'error'); }
        }

        async function handleGradingFormSubmit(form) {
            const questId = form.dataset.questId;
            const inputs = form.querySelectorAll('.grade-input');
            const batch = writeBatch(db);
            let changesCount = 0;

            for (const input of inputs) {
                const studentId = input.dataset.studentId;
                const newScore = parseInt(input.value, 10);

                if (!isNaN(newScore)) {
                    const submissionId = `${studentId}_${questId}`;
                    const submissionRef = doc(db, "submissions", submissionId);
                    const studentRef = doc(db, "students", studentId);

                    const submissionDoc = await getDoc(submissionRef);
                    const originalScore = submissionDoc.exists() ? submissionDoc.data().score : 0;
                    
                    if(newScore !== originalScore) {
                        changesCount++;
                        batch.set(submissionRef, {
                            studentId, questId, score: newScore, status: 'completed', teacherId: currentTeacher.uid
                        }, { merge: true });

                        const xpDifference = newScore - originalScore;
                        batch.update(studentRef, { totalXP: increment(xpDifference) });
                    }
                }
            }

            if (changesCount === 0) return showAlert('Nenhuma nota foi alterada.');

            try {
                await batch.commit();
                showAlert('Notas salvas com sucesso!');
                hideModal();
            } catch(error) { showAlert(`Erro ao salvar as notas: ${error.message}`, 'error'); }
        }

        async function handleMessageFormSubmit(form) {
            const type = form.querySelector('input[name="message-type"]:checked').value;
            const content = form.querySelector('#message-content').value;
            if(!content) return showAlert('A mensagem não pode estar vazia.', 'error');
            
            const messageData = {
                content,
                type,
                teacherName: currentTeacher.name,
                teacherId: currentTeacher.uid,
                timestamp: serverTimestamp()
            };

            if (type === 'personal') {
                const studentId = form.querySelector('#message-student-select').value;
                if(!studentId) return showAlert('Selecione um aluno para enviar a mensagem pessoal.', 'error');
                messageData.studentId = studentId;
            }
            
            try {
                await addDoc(collection(db, "messages"), messageData);
                showAlert('Mensagem enviada com sucesso!');
                form.querySelector('#message-content').value = '';
            } catch (error) { showAlert(`Erro ao enviar mensagem: ${error.message}`, 'error'); }
        }

        async function handleStudentImport(form) {
            const file = form.querySelector('#csv-file-students').files[0];
            if (!file) return showAlert('Por favor, selecione um arquivo.', 'error');

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csv = event.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) return showAlert('Arquivo CSV vazio ou com apenas cabeçalho.', 'error');

                const header = lines[0].trim().split(',');
                if (header[0] !== 'nome' || header[1] !== 'matricula' || header[2] !== 'turma') {
                    return showAlert('Cabeçalho do CSV inválido. Use: nome,matricula,turma', 'error');
                }

                const batch = writeBatch(db);
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].trim().split(',');
                    const studentData = {
                        name: values[0],
                        matricula: values[1],
                        turma: values[2],
                        teacherId: currentTeacher.uid,
                        totalXP: 0,
                        lastSeenXP: 0
                    };
                    const newStudentRef = doc(collection(db, "students"));
                    batch.set(newStudentRef, studentData);
                }

                try {
                    await batch.commit();
                    showAlert(`${lines.length - 1} alunos importados com sucesso!`);
                    hideModal();
                } catch (error) {
                    showAlert(`Erro ao importar alunos: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handleQuestImport(form) {
             const file = form.querySelector('#csv-file-quests').files[0];
            if (!file) return showAlert('Por favor, selecione um arquivo.', 'error');

            const reader = new FileReader();
            reader.onload = async (event) => {
                const csv = event.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                 if (lines.length <= 1) return showAlert('Arquivo CSV vazio ou com apenas cabeçalho.', 'error');

                const header = lines[0].trim().split(',');
                if (header[0] !== 'titulo' || header[1] !== 'descricao' || header[2] !== 'dificuldade' || header[3] !== 'xp' || header[4] !== 'turmas' || header[5] !== 'prazo') {
                    return showAlert('Cabeçalho do CSV inválido. Use: titulo,descricao,dificuldade,xp,turmas,prazo (formato AAAA-MM-DD)', 'error');
                }

                const batch = writeBatch(db);
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].trim().split(',');
                    const questData = {
                        title: values[0],
                        description: values[1],
                        difficulty: values[2],
                        maxXp: parseInt(values[3], 10),
                        turmas: values[4].split(';').map(t => t.trim()), // Use semicolon for multiple classes
                        endDate: Timestamp.fromDate(new Date(values[5].replace(/-/g, '\/'))),
                        teacherId: currentTeacher.uid
                    };
                    const newQuestRef = doc(collection(db, "quests"));
                    batch.set(newQuestRef, questData);
                }

                try {
                    await batch.commit();
                    showAlert(`${lines.length - 1} quests importadas com sucesso!`);
                    hideModal();
                } catch (error) {
                    showAlert(`Erro ao importar quests: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handleEpicWorkFormSubmit(form) {
            const id = form.dataset.id;
            const questSelect = form.querySelector('#epic-quest-select');
            const questId = questSelect.value;
            const questTitle = questSelect.options[questSelect.selectedIndex].text;
            const workLink = form.querySelector('#epic-work-link').value;
            
            const selectedStudents = Array.from(form.querySelectorAll('input[name="epic-students"]:checked'));
            const studentIds = selectedStudents.map(el => el.value);
            const studentNames = selectedStudents.map(el => el.dataset.name);

            if (!questId || !workLink || studentIds.length === 0) {
                return showAlert('Preencha todos os campos: Quest, Link e ao menos um Aluno.', 'error');
            }

            const epicData = { questId, questTitle, workLink, studentIds, studentNames, teacherId: currentTeacher.uid, timestamp: serverTimestamp() };

            try {
                if (id) {
                    await updateDoc(doc(db, "epicWorks", id), epicData);
                    showAlert('Trabalho Épico atualizado!');
                } else {
                    await addDoc(collection(db, "epicWorks"), epicData);
                    showAlert('Trabalho Épico registrado com sucesso!');
                }
                hideModal();
            } catch (error) {
                showAlert(`Erro ao salvar Trabalho Épico: ${error.message}`, 'error');
            }
        }

        async function handleDeleteEpicWork(epicWorkId) {
             if (!window.confirm('Tem certeza que deseja remover este Trabalho Épico?')) return;
            try {
                await deleteDoc(doc(db, "epicWorks", epicWorkId));
                showAlert('Trabalho Épico removido.');
            } catch (error) { showAlert(`Erro ao remover: ${error.message}`, 'error'); }
        }

        async function handleGradeImport(form) {
            const questId = form.dataset.questId;
            const file = form.querySelector('#csv-file-grades').files[0];
            if (!file) return showAlert('Por favor, selecione um arquivo.', 'error');

            loadingSpinner.style.display = 'flex';

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        loadingSpinner.style.display = 'none';
                        return showAlert('Arquivo CSV vazio ou com apenas cabeçalho.', 'error');
                    }

                    const header = lines[0].trim().split(',');
                    if (header[0] !== 'matricula' || header[1] !== 'xp_ganho') {
                        loadingSpinner.style.display = 'none';
                        return showAlert('Cabeçalho do CSV inválido. Use: matricula,xp_ganho', 'error');
                    }

                    const batch = writeBatch(db);
                    let processedCount = 0;

                    const allStudentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
                    const studentsSnapshot = await getDocs(allStudentsQuery);
                    const studentMap = new Map();
                    studentsSnapshot.forEach(doc => {
                        studentMap.set(doc.data().matricula, doc.id);
                    });
                    
                    const submissionsQuery = query(collection(db, "submissions"), where("questId", "==", questId));
                    const submissionsSnapshot = await getDocs(submissionsQuery);
                    const originalScores = new Map();
                    submissionsSnapshot.forEach(doc => {
                        originalScores.set(doc.data().studentId, doc.data().score);
                    });

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].trim().split(',');
                        const matricula = values[0];
                        const newScore = parseInt(values[1], 10);

                        if (matricula && !isNaN(newScore)) {
                            const studentId = studentMap.get(matricula);
                            if (studentId) {
                                const submissionId = `${studentId}_${questId}`;
                                const submissionRef = doc(db, "submissions", submissionId);
                                const studentRef = doc(db, "students", studentId);
                                
                                const originalScore = originalScores.get(studentId) || 0;
                                const xpDifference = newScore - originalScore;

                                batch.set(submissionRef, {
                                    studentId, questId, score: newScore, status: 'completed', teacherId: currentTeacher.uid
                                }, { merge: true });
                                
                                if (xpDifference !== 0) {
                                    batch.update(studentRef, { totalXP: increment(xpDifference) });
                                }
                                processedCount++;
                            }
                        }
                    }

                    await batch.commit();
                    loadingSpinner.style.display = 'none';
                    showAlert(`${processedCount} notas importadas com sucesso!`);
                    hideModal();

                } catch (error) {
                    loadingSpinner.style.display = 'none';
                    showAlert(`Erro ao importar notas: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handlePastResultFormSubmit(form) {
            const id = form.dataset.id;
            const studentId = form.querySelector('#past-result-student-select').value;
            const period = form.querySelector('#past-result-period').value.trim();
            const grade = parseFloat(form.querySelector('#past-result-grade').value.replace(',', '.'));

            if (!studentId || !period || isNaN(grade)) {
                return showAlert('Preencha todos os campos corretamente.', 'error');
            }

            const resultData = { studentId, period, grade, teacherId: currentTeacher.uid };
            
            try {
                if (id) {
                    await updateDoc(doc(db, 'pastResults', id), resultData);
                    showAlert('Resultado atualizado com sucesso!');
                } else {
                    await addDoc(collection(db, 'pastResults'), resultData);
                    showAlert('Resultado anterior adicionado!');
                }
                hideModal();
                renderPastResultsTab(); // Refresh the tab
            } catch (error) {
                 showAlert(`Erro ao salvar resultado: ${error.message}`, 'error');
            }
        }

        async function handlePastResultImport(form) {
            const file = form.querySelector('#csv-file-past-results').files[0];
            if (!file) return showAlert('Por favor, selecione um arquivo.', 'error');

            loadingSpinner.style.display = 'flex';
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim() !== '');
                    if (lines.length <= 1) {
                        loadingSpinner.style.display = 'none';
                        return showAlert('Arquivo CSV vazio ou com apenas cabeçalho.', 'error');
                    }

                    const header = lines[0].trim().split(',');
                    if (header[0] !== 'matricula' || header[1] !== 'periodo' || header[2] !== 'nota_final') {
                         loadingSpinner.style.display = 'none';
                        return showAlert('Cabeçalho do CSV inválido. Use: matricula,periodo,nota_final', 'error');
                    }

                    const studentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
                    const studentsSnapshot = await getDocs(studentsQuery);
                    const studentMap = new Map();
                    studentsSnapshot.forEach(doc => studentMap.set(doc.data().matricula, doc.id));
                    
                    const batch = writeBatch(db);
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].trim().split(',');
                        const matricula = values[0];
                        const period = values[1];
                        const grade = parseFloat(values[2].replace(',', '.'));
                        const studentId = studentMap.get(matricula);

                        if (studentId && period && !isNaN(grade)) {
                            const newResultRef = doc(collection(db, "pastResults"));
                            batch.set(newResultRef, { studentId, period, grade, teacherId: currentTeacher.uid });
                        }
                    }

                    await batch.commit();
                    loadingSpinner.style.display = 'none';
                    showAlert('Resultados importados com sucesso!');
                    hideModal();
                    renderPastResultsTab();
                } catch(e) {
                    loadingSpinner.style.display = 'none';
                    showAlert(`Erro ao importar: ${e.message}`, 'error');
                }
            };
            reader.readAsText(file);
        }

        async function handleDeletePastResult(resultId) {
            if (!window.confirm('Tem certeza que deseja apagar este resultado?')) return;
            try {
                await deleteDoc(doc(db, "pastResults", resultId));
                showAlert('Resultado removido.');
                renderPastResultsTab();
            } catch (error) {
                showAlert(`Erro ao apagar: ${error.message}`, 'error');
            }
        }
        
        // --- VIEW & COMPONENT RENDERING (The HTML Generators) ---
        
        async function renderLoginView() {
            const html = `
                <div id="login-view">
                    <header class="text-center mb-8">
                        <h1 class="font-game text-4xl md:text-6xl text-cyan-400 drop-shadow-[0_4px_4px_rgba(0,255,255,0.25)]">Level Up!</h1>
                        <p class="text-gray-300 mt-4 text-lg">Sua Jornada para se tornar um Dev Lendário começa aqui.</p>
                    </header>
                    
                    <div id="top-5-podium-container" class="mb-12">
                        <h2 class="font-game text-3xl text-center text-yellow-400 mb-8">Top 5 Devs</h2>
                        <div id="top-5-podium" class="flex justify-center items-end gap-4 flex-wrap">
                            <p class="text-gray-400">Carregando o pódio...</p>
                        </div>
                    </div>

                    <div id="epic-works-showcase-container" class="mb-12"></div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="glass-effect p-8 rounded-2xl">
                            <h2 class="font-game text-2xl text-lime-400 mb-4">Área do Dev</h2>
                            <p class="text-gray-400 mb-6">Insira sua matrícula para carregar seu progresso ou encontre-a pelo seu nome.</p>
                            <div class="space-y-4">
                                <input type="text" id="student-id-input" placeholder="Digite sua Matrícula" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <button id="login-student-btn" class="w-full bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Ver Minha Jornada</button>
                            </div>
                            <div class="text-center my-4 text-gray-500">ou</div>
                            <div class="space-y-4">
                                <input type="text" id="student-name-search" placeholder="Digite seu nome completo" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-lime-500">
                                <button id="search-student-btn" class="w-full bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Encontrar Matrícula</button>
                                <div id="student-search-result" class="text-center mt-4 text-yellow-400 font-semibold"></div>
                            </div>
                        </div>
                        <div class="glass-effect p-8 rounded-2xl">
                            <h2 class="font-game text-2xl text-yellow-400 mb-4">Área do Mestre</h2>
                            <p class="text-gray-400 mb-6">Login para Mestres da Guilda e Administradores.</p>
                            <form id="teacher-login-form" class="space-y-4">
                                <input type="email" id="teacher-email" placeholder="Email" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <input type="password" id="teacher-password" placeholder="Senha" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                                <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Entrar</button>
                            </form>
                            <p class="text-center mt-4 text-sm text-gray-400">Não tem uma conta? <a href="#" id="show-register-link" class="text-cyan-400 hover:underline">Cadastre-se aqui</a>.</p>
                        </div>
                    </div>
                    <div id="general-messages-board" class="mt-8 glass-effect p-6 rounded-2xl hidden"></div>
                </div>`;
            showView(html);
            renderTop5Podium();
            renderEpicWorksShowcase();
        }
        
        async function renderTop5Podium() {
            const podiumContainer = document.getElementById('top-5-podium');
            if (!podiumContainer) return;

            try {
                const q = query(collection(db, "students"));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    podiumContainer.innerHTML = '<p class="text-gray-400">Ainda não há devs no ranking para o pódio.</p>';
                    return;
                }

                const students = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const top5 = students.sort((a, b) => (b.totalXP || 0) - (a.totalXP || 0)).slice(0, 5);

                const podiumOrder = [1, 0, 2, 3, 4];
                let podiumHTML = '';

                for(const index of podiumOrder) {
                    if (top5[index]) {
                        const student = top5[index];
                        const rank = index + 1;
                        let heightClass = 'h-32';
                        let rankColor = 'bg-gray-600 text-white';
                        let podiumClass = 'podium-other';
                        let icon = `<i class="fas fa-star text-yellow-300"></i>`;

                        if (rank === 1) { heightClass = 'h-48'; podiumClass = 'podium-1'; rankColor = 'bg-yellow-400 text-black'; icon = `<i class="fas fa-crown text-yellow-400"></i>`; } 
                        else if (rank === 2) { heightClass = 'h-40'; podiumClass = 'podium-2'; rankColor = 'bg-gray-300 text-black'; icon = `<i class="fas fa-medal text-gray-300"></i>`; } 
                        else if (rank === 3) { heightClass = 'h-32'; podiumClass = 'podium-3'; rankColor = 'bg-yellow-600 text-white'; icon = `<i class="fas fa-award text-yellow-600"></i>`; }
                        
                        podiumHTML += `
                            <div class="relative podium-item glass-effect rounded-t-lg border-b-4 ${podiumClass} w-48 ${heightClass} flex flex-col items-center justify-center p-4 text-center">
                                <div class="podium-rank ${rankColor}">${rank}</div>
                                <div class="text-2xl mb-2">${icon}</div>
                                <h3 class="font-bold text-lg truncate w-full">${student.name}</h3>
                                <p class="font-game text-lime-400 text-sm">${student.totalXP || 0} XP</p>
                            </div>`;
                    }
                }
                podiumContainer.innerHTML = podiumHTML || '<p class="text-gray-400">Ainda não há devs no ranking para o pódio.</p>';

            } catch (error) {
                console.error("Error rendering podium:", error);
                podiumContainer.innerHTML = '<p class="text-red-500">Erro ao carregar o pódio.</p>';
            }
        }

        async function renderEpicWorksShowcase() {
            const container = document.getElementById('epic-works-showcase-container');
            if (!container) return;

            container.innerHTML = `<h2 class="font-game text-3xl text-center text-purple-400 mb-8">Trabalhos Épicos</h2>
                                   <div id="epic-works-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                                       <p class="text-gray-400 col-span-full text-center">Carregando trabalhos...</p>
                                   </div>`;

            try {
                const q = query(collection(db, "epicWorks"));
                const snapshot = await getDocs(q);
                const listContainer = document.getElementById('epic-works-list');

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-400 col-span-full text-center">Nenhum trabalho épico registrado ainda.</p>';
                    return;
                }
                
                const sortedWorks = snapshot.docs.sort((a,b) => {
                    const timeA = a.data().timestamp?.toDate() || 0;
                    const timeB = b.data().timestamp?.toDate() || 0;
                    return timeB - timeA;
                });

                listContainer.innerHTML = sortedWorks.map(doc => {
                    const work = doc.data();
                    return `
                        <div class="glass-effect rounded-lg p-6 flex flex-col epic-highlight">
                            <div class="flex-grow">
                                <h3 class="font-bold text-lg text-purple-300">${work.questTitle}</h3>
                                <p class="text-sm text-gray-400 mt-2">Por: ${work.studentNames.join(', ')}</p>
                            </div>
                            <a href="${work.workLink}" target="_blank" rel="noopener noreferrer" class="mt-4 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg text-center">
                                Ver Trabalho <i class="fas fa-external-link-alt ml-2"></i>
                            </a>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error("Error rendering epic works:", error);
                document.getElementById('epic-works-list').innerHTML = '<p class="text-red-500 col-span-full text-center">Erro ao carregar os trabalhos.</p>';
            }
        }

        function renderRegisterView() {
            const html = `
                <div id="register-view" class="max-w-md mx-auto">
                     <div class="glass-effect p-8 rounded-2xl">
                        <h2 class="font-game text-2xl text-yellow-400 mb-6 text-center">Cadastro de Mestre</h2>
                        <form id="teacher-register-form" class="space-y-4">
                            <input type="text" id="register-name" placeholder="Nome Completo" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="email" id="register-email" placeholder="Email" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <input type="password" id="register-password" placeholder="Senha (mínimo 6 caracteres)" required class="w-full bg-gray-800 border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:ring-2 focus:ring-yellow-500">
                            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-4 rounded-lg transition-transform transform hover:scale-105">Solicitar Cadastro</button>
                        </form>
                        <p class="text-center mt-4 text-sm text-gray-400"><a href="#" id="show-login-link" class="text-cyan-400 hover:underline">Voltar para o Login</a></p>
                    </div>
                </div>`;
            showView(html);
        }

        async function renderAdminDashboard() {
            const html = `
                <header class="flex flex-wrap justify-between items-center mb-8">
                    <h1 class="font-game text-2xl md:text-3xl text-red-500">Painel do Administrador</h1>
                    <button class="logout-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                </header>
                <div class="glass-effect p-6 rounded-2xl">
                    <h2 class="font-game text-xl text-yellow-400 mb-4">Aprovação de Mestres</h2>
                    <div id="admin-teacher-approval-list" class="space-y-4"></div>
                </div>`;
            showView(html);
            
            const listContainer = document.getElementById('admin-teacher-approval-list');
            const q = query(collection(db, "users"), where("role", "==", "teacher"), where("status", "==", "pending"));
            const unsub = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-400">Nenhum Mestre aguardando aprovação.</p>';
                    return;
                }
                listContainer.innerHTML = '';
                snapshot.forEach((doc) => {
                    const teacher = doc.data();
                    const card = document.createElement('div');
                    card.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
                    card.innerHTML = `
                        <div>
                            <p class="font-bold">${teacher.name}</p>
                            <p class="text-sm text-gray-400">${teacher.email}</p>
                        </div>
                        <div class="space-x-2">
                            <button data-id="${doc.id}" class="approve-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded">Aprovar</button>
                            <button data-id="${doc.id}" class="reject-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded">Rejeitar</button>
                        </div>`;
                    listContainer.appendChild(card);
                });
            });
            unsubscribeListeners.push(unsub);
        }

        async function renderTeacherDashboard() {
            const { name, status } = currentTeacher;
            let contentHTML = '';

            if (status === 'pending') {
                contentHTML = `<div class="glass-effect p-6 rounded-2xl text-center text-yellow-300"><h2 class="font-game text-2xl mb-4">Aguardando Aprovação</h2><p>Seu cadastro foi enviado e está aguardando a aprovação do administrador.</p></div>`;
            } else if (status === 'rejected') {
                contentHTML = `<div class="glass-effect p-6 rounded-2xl text-center text-red-400"><h2 class="font-game text-2xl mb-4">Acesso Negado</h2><p>Seu cadastro não foi aprovado.</p></div>`;
            } else {
                contentHTML = `
                    <div class="mb-6 border-b border-gray-600">
                        <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
                            <a href="#" data-tab="students" class="teacher-tab active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Gerenciar Devs</a>
                            <a href="#" data-tab="quests" class="teacher-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Gerenciar Quests</a>
                            <a href="#" data-tab="epic-works" class="teacher-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Trabalhos Épicos</a>
                            <a href="#" data-tab="past-results" class="teacher-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Resultados Anteriores</a>
                            <a href="#" data-tab="messages" class="teacher-tab whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Enviar Mensagens</a>
                        </nav>
                    </div>
                    <div id="tab-content-students" class="teacher-tab-content active"></div>
                    <div id="tab-content-quests" class="teacher-tab-content"></div>
                    <div id="tab-content-epic-works" class="teacher-tab-content"></div>
                    <div id="tab-content-past-results" class="teacher-tab-content"></div>
                    <div id="tab-content-messages" class="teacher-tab-content"></div>`;
            }

            const viewHTML = `
                <header class="flex flex-wrap justify-between items-center mb-8">
                    <h1 class="font-game text-2xl md:text-3xl text-yellow-400">Painel do Mestre ${name}</h1>
                    <button class="logout-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Sair</button>
                </header>
                ${contentHTML}`;
            showView(viewHTML);
            if (status === 'approved') renderStudentsTab();
        }
        
        async function renderStudentDashboard(studentId, studentData){
            let levelUpClass = '';
            if (studentData.totalXP > (studentData.lastSeenXP || 0)) {
                levelUpClass = 'level-up';
                await updateDoc(doc(db, "students", studentId), { lastSeenXP: studentData.totalXP });
            }

            const motivationalPhrases = ["Bugs são features inesperadas.", "Compilou? Shippa!", "Keep calm and code on."];
            const phrase = motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)];

            const html = `
                <header class="flex flex-wrap justify-between items-center mb-8">
                    <div>
                        <h1 class="font-game text-2xl md:text-3xl text-cyan-400">Jornada de ${studentData.name.split(' ')[0]}</h1>
                        <p id="student-level" class="text-lg text-lime-400 ${levelUpClass}"><i class="fas fa-star mr-2"></i>XP Total: ${studentData.totalXP || 0}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="show-past-results-btn" data-student-id="${studentId}" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-history mr-2"></i>Períodos Anteriores</button>
                        <button class="logout-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-sign-out-alt mr-2"></i>Sair da Jornada</button>
                    </div>
                </header>
                
                <div id="personal-message-box" class="hidden glass-effect p-4 mb-6 bg-purple-500 bg-opacity-30 border border-purple-400 rounded-lg"></div>

                <div class="grid lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 glass-effect p-6 rounded-2xl">
                        <h2 class="font-game text-2xl text-fuchsia-400 mb-6"><i class="fas fa-scroll mr-2"></i>Suas Quests</h2>
                        <div id="student-timeline" class="space-y-6">Carregando...</div>
                    </div>
                    <div class="space-y-8">
                        <div class="glass-effect p-6 rounded-2xl">
                            <h2 class="font-game text-xl text-yellow-400 mb-4"><i class="fas fa-trophy mr-2"></i>Leaderboard</h2>
                            <select id="leaderboard-filter" data-student-id="${studentId}" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 mb-4">
                                <option value="general">Geral</option>
                                <option value="${studentData.turma}">Minha Turma (${studentData.turma})</option>
                            </select>
                            <ul id="leaderboard-list" class="space-y-3">Carregando...</ul>
                        </div>
                         <div class="glass-effect p-6 rounded-2xl">
                            <h2 class="font-game text-xl text-cyan-400 mb-4"><i class="fas fa-lightbulb mr-2"></i>Frase do Dia</h2>
                            <p class="text-center italic text-gray-300">"${phrase}"</p>
                        </div>
                    </div>
                </div>
            `;
            showView(html);
            renderStudentTimeline(studentId, studentData.turma);
            loadPersonalMessages(studentId);
            renderStudentLeaderboard('general', studentId);
        }
        
        async function renderStudentsTab() { 
            const container = document.getElementById('tab-content-students');
            if(!container) return;
            container.innerHTML = `
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                  <h2 class="font-game text-xl text-cyan-400">Devs (Alunos)</h2>
                  <div class="flex gap-2">
                    <button id="import-students-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-upload mr-2"></i>Importar</button>
                    <button class="add-student-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Adicionar</button>
                  </div>
                </div>
                <div id="students-list" class="glass-effect p-4 rounded-lg">Carregando...</div>`;
            
            const q = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
            const unsub = onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('students-list');
                if(!listContainer) return;

                if(snapshot.empty){
                    listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum Dev cadastrado ainda.</p>';
                    return;
                }
                
                const sortedDocs = snapshot.docs.sort((a, b) => a.data().name.localeCompare(b.data().name));

                const tableRows = sortedDocs.map(doc => {
                    const student = {id: doc.id, ...doc.data()};
                    return `
                        <tr class="bg-gray-800 border-b border-gray-700">
                            <td class="px-6 py-4 font-medium text-white whitespace-nowrap">${student.name}</td>
                            <td class="px-6 py-4">${student.matricula}</td>
                            <td class="px-6 py-4">${student.turma}</td>
                            <td class="px-6 py-4 text-right space-x-4">
                                <button data-id="${student.id}" class="edit-student-btn text-blue-400 hover:text-blue-300 p-2"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${student.id}" class="delete-student-btn text-red-500 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>`;
                }).join('');
                listContainer.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Nome</th><th scope="col" class="px-6 py-3">Matrícula</th>
                                    <th scope="col" class="px-6 py-3">Turma</th><th scope="col" class="px-6 py-3 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    </div>`;
            });
            unsubscribeListeners.push(unsub);
        }
        
        async function renderQuestsTab() {
            const container = document.getElementById('tab-content-quests');
            if(!container) return;
            container.innerHTML = `
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                  <h2 class="font-game text-xl text-cyan-400">Quests (Atividades)</h2>
                  <div class="flex gap-2">
                    <button id="import-quests-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-upload mr-2"></i>Importar</button>
                    <button class="add-quest-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Criar</button>
                  </div>
                </div>
                <div id="quests-list" class="space-y-4">Carregando...</div>`;

            const q = query(collection(db, "quests"), where("teacherId", "==", currentTeacher.uid));
            const unsub = onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('quests-list');
                if(!listContainer) return;
                if(snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhuma Quest criada ainda.</p>';
                    return;
                }
                
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().endDate?.toDate() || 0;
                    const timeB = b.data().endDate?.toDate() || 0;
                    return timeB - timeA;
                });

                listContainer.innerHTML = sortedDocs.map(doc => {
                    const quest = {id: doc.id, ...doc.data()};
                    return `
                        <div class="glass-effect p-4 rounded-lg flex flex-col md:flex-row justify-between items-start md:items-center">
                            <div>
                                <h3 class="font-bold text-lg text-cyan-300">${quest.title}</h3>
                                <p class="text-sm text-gray-400">${quest.description}</p>
                                <div class="text-xs text-gray-500 mt-2">
                                    <span>XP: ${quest.maxXp}</span> | <span>Turmas: ${quest.turmas.join(', ')}</span> | <span>Prazo: ${quest.endDate.toDate().toLocaleDateString('pt-BR')}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 mt-4 md:mt-0">
                                <button data-id="${quest.id}" class="grade-quest-btn bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-1 px-3 rounded-lg"><i class="fas fa-award mr-2"></i>Lançar XP</button>
                                <button data-id="${quest.id}" class="edit-quest-btn text-blue-400 hover:text-blue-300 p-2"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${quest.id}" class="delete-quest-btn text-red-500 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            });
            unsubscribeListeners.push(unsub);
        }

        async function renderEpicWorksTab() {
            const container = document.getElementById('tab-content-epic-works');
            if(!container) return;
            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                  <h2 class="font-game text-xl text-purple-400">Trabalhos Épicos</h2>
                  <button class="add-epic-work-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Registrar Trabalho</button>
                </div>
                <div id="epic-works-teacher-list" class="space-y-4">Carregando...</div>`;

            const q = query(collection(db, "epicWorks"), where("teacherId", "==", currentTeacher.uid));
            const unsub = onSnapshot(q, (snapshot) => {
                const listContainer = document.getElementById('epic-works-teacher-list');
                if (!listContainer) return;
                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum trabalho épico registrado.</p>';
                    return;
                }
                const sortedDocs = snapshot.docs.sort((a, b) => {
                    const timeA = a.data().timestamp?.toDate() || 0;
                    const timeB = b.data().timestamp?.toDate() || 0;
                    return timeB - timeA;
                });
                listContainer.innerHTML = sortedDocs.map(doc => {
                    const work = { id: doc.id, ...doc.data() };
                    return `
                        <div class="glass-effect p-4 rounded-lg flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-lg text-purple-300">${work.questTitle}</h3>
                                <p class="text-sm text-gray-400">Alunos: ${work.studentNames.join(', ')}</p>
                                <a href="${work.workLink}" target="_blank" class="text-xs text-cyan-400 hover:underline">${work.workLink}</a>
                            </div>
                            <div class="flex space-x-2">
                                <button data-id="${work.id}" class="edit-epic-work-btn text-blue-400 hover:text-blue-300 p-2"><i class="fas fa-pencil-alt"></i></button>
                                <button data-id="${work.id}" class="delete-epic-work-btn text-red-500 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            });
            unsubscribeListeners.push(unsub);
        }
        
        async function renderMessagesTab() {
            const container = document.getElementById('tab-content-messages');
            if(!container) return;
            container.innerHTML = `
                <h2 class="font-game text-xl text-cyan-400 mb-4">Enviar Mensagem</h2>
                <form id="message-form" class="glass-effect p-6 rounded-lg space-y-4">
                    <div>
                        <label class="block mb-2 text-sm font-medium">Tipo de Mensagem</label>
                        <div class="flex items-center space-x-4">
                            <label><input type="radio" name="message-type" value="general" checked class="mr-2">Geral (para todos)</label>
                            <label><input type="radio" name="message-type" value="personal" class="mr-2">Pessoal (para um Dev)</label>
                        </div>
                    </div>
                    <div id="student-select-container" style="display:none;">
                        <label for="message-student-select" class="block mb-2 text-sm font-medium">Selecione o Dev</label>
                        <select id="message-student-select" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2"></select>
                    </div>
                    <div>
                        <label for="message-content" class="block mb-2 text-sm font-medium">Sua Mensagem</label>
                        <textarea id="message-content" rows="4" class="w-full bg-gray-800 border border-gray-600 rounded-lg p-2" required></textarea>
                    </div>
                    <div class="text-right">
                        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">Enviar Mensagem</button>
                    </div>
                </form>
            `;
            
            const q = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
            const snapshot = await getDocs(q);
            const select = document.getElementById('message-student-select');
            select.innerHTML = '<option value="">-- Selecione --</option>';

            const sortedDocs = snapshot.docs.sort((a, b) => a.data().name.localeCompare(b.data().name));
            sortedDocs.forEach(doc => {
                select.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
        }

        async function renderPastResultsTab() {
            const container = document.getElementById('tab-content-past-results');
            if(!container) return;
             container.innerHTML = `
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                  <h2 class="font-game text-xl text-cyan-400">Resultados de Períodos Anteriores</h2>
                  <div class="flex gap-2">
                    <button id="import-past-results-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-upload mr-2"></i>Importar</button>
                  </div>
                </div>
                <div id="past-results-list" class="glass-effect p-4 rounded-lg">Carregando...</div>`;

            const listContainer = document.getElementById('past-results-list');

            const studentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
            const pastResultsQuery = query(collection(db, "pastResults"), where("teacherId", "==", currentTeacher.uid));

            const [studentsSnapshot, pastResultsSnapshot] = await Promise.all([getDocs(studentsQuery), getDocs(pastResultsQuery)]);

            if (studentsSnapshot.empty) {
                listContainer.innerHTML = '<p class="text-center text-gray-400">Nenhum Dev cadastrado para lançar resultados.</p>';
                return;
            }

            const resultsByStudent = {};
            pastResultsSnapshot.forEach(doc => {
                const data = doc.data();
                if (!resultsByStudent[data.studentId]) {
                    resultsByStudent[data.studentId] = [];
                }
                resultsByStudent[data.studentId].push({ id: doc.id, ...data });
            });
            
            const sortedStudents = studentsSnapshot.docs.sort((a, b) => a.data().name.localeCompare(b.data().name));

            listContainer.innerHTML = sortedStudents.map(studentDoc => {
                const student = { id: studentDoc.id, ...studentDoc.data() };
                const results = resultsByStudent[student.id] || [];
                const resultsHTML = results.map(res => `
                    <div class="flex items-center justify-between bg-gray-900 p-2 rounded-md">
                        <span>Período: <strong>${res.period}</strong> - Nota: <strong>${res.grade}</strong></span>
                        <div class="space-x-2">
                            <button data-id="${res.id}" class="edit-past-result-btn text-blue-400 hover:text-blue-300 text-xs"><i class="fas fa-pencil-alt"></i></button>
                            <button data-id="${res.id}" class="delete-past-result-btn text-red-500 hover:text-red-400 text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="font-bold text-lg">${student.name}</h3>
                            <button data-student-id="${student.id}" class="add-past-result-btn bg-green-500 hover:bg-green-600 text-white font-bold text-sm py-1 px-3 rounded-lg"><i class="fas fa-plus mr-1"></i>Adicionar</button>
                        </div>
                        <div class="mt-3 space-y-2">
                            ${resultsHTML || '<p class="text-sm text-gray-500">Nenhum resultado anterior lançado.</p>'}
                        </div>
                    </div>
                `;
            }).join('<div class="my-4 border-b border-gray-700"></div>');
        }
        
        async function renderStudentTimeline(studentId, studentTurma) {
            const timelineContainer = document.getElementById('student-timeline');
            if(!timelineContainer) return;
            
            const questsQuery = query(collection(db, "quests"), where("turmas", "array-contains", studentTurma));
            const questsSnapshot = await getDocs(questsQuery);
            const sortedQuests = questsSnapshot.docs.sort((a,b) => {
                const timeA = a.data().endDate?.toDate() || 0;
                const timeB = b.data().endDate?.toDate() || 0;
                return timeB - timeA;
            });

            const submissionsQuery = query(collection(db, "submissions"), where("studentId", "==", studentId));
            const submissionsSnapshot = await getDocs(submissionsQuery);
            const studentSubmissions = {};
            submissionsSnapshot.forEach(doc => {
                const data = doc.data();
                studentSubmissions[data.questId] = { score: data.score, status: data.status };
            });

            const epicWorksQuery = query(collection(db, "epicWorks"), where("studentIds", "array-contains", studentId));
            const epicWorksSnapshot = await getDocs(epicWorksQuery);
            const epicQuestIds = epicWorksSnapshot.docs.map(doc => doc.data().questId);
            
            if(sortedQuests.length === 0){
                timelineContainer.innerHTML = '<p class="text-gray-400">Nenhuma quest foi atribuída para sua turma ainda.</p>';
                return;
            }

            timelineContainer.innerHTML = sortedQuests.map(doc => {
                const quest = doc.data();
                const questId = doc.id;
                const submission = studentSubmissions[questId];
                const isEpic = epicQuestIds.includes(questId);
                
                let icon = 'fa-hourglass-half text-yellow-400';
                let xpText = `Vale até ${quest.maxXp} XP`;
                let epicClass = isEpic ? 'epic-highlight' : '';

                if (submission) {
                    icon = isEpic ? 'fa-meteor text-purple-400' : 'fa-check-circle text-green-400';
                    xpText = `Você ganhou ${submission.score} XP`;
                } else if (quest.endDate.toDate() < new Date()) {
                    icon = 'fa-times-circle text-red-400';
                    xpText = `Você perdeu ${quest.maxXp} XP`;
                }

                return `
                    <div class="flex items-start space-x-4">
                        <div class="flex flex-col items-center flex-shrink-0">
                            <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center ${epicClass}">
                                <i class="fas ${icon} text-2xl"></i>
                            </div>
                            <div class="w-0.5 h-16 bg-gray-600 mt-2"></div>
                        </div>
                        <div class="glass-effect p-4 rounded-lg flex-1 ${epicClass}">
                            <div class="flex justify-between items-center flex-wrap gap-2">
                                <h3 class="font-bold text-lg ${isEpic ? 'text-purple-300' : 'text-cyan-300'}">${quest.title} ${isEpic ? '(ÉPICO!)' : ''}</h3>
                                <span class="text-sm font-semibold text-lime-400 whitespace-nowrap">${xpText}</span>
                            </div>
                            <p class="text-gray-400 text-sm mt-1">${quest.description}</p>
                            <div class="text-xs text-gray-500 mt-3">
                                <span>Dificuldade: ${quest.difficulty}</span> | 
                                <span>Prazo: ${quest.endDate.toDate().toLocaleDateString('pt-BR')}</span>
                            </div>
                        </div>
                    </div>`;
            }).join('') || '<p class="text-gray-400">Sua jornada começa em breve!</p>';
        }

        async function loadPersonalMessages(studentId) {
            const box = document.getElementById('personal-message-box');
            if(!box) return;

            const q = query(collection(db, "messages"), where("studentId", "==", studentId));
            const unsub = onSnapshot(q, (snapshot) => {
                if(!snapshot.empty) {
                    const sortedMessages = snapshot.docs.sort((a,b) => {
                        const timeA = a.data().timestamp?.toDate() || 0;
                        const timeB = b.data().timestamp?.toDate() || 0;
                        return timeB - timeA;
                    });
                    const message = sortedMessages[0].data(); // Show the latest
                    box.innerHTML = `
                        <h3 class="font-bold text-purple-300"><i class="fas fa-envelope mr-2"></i> Mensagem do seu Mestre:</h3>
                        <p class="italic">"${message.content}"</p>`;
                    box.classList.remove('hidden');
                } else {
                    box.classList.add('hidden');
                }
            });
            unsubscribeListeners.push(unsub);
        }

        async function renderStudentLeaderboard(filter, currentStudentId) {
            const list = document.getElementById('leaderboard-list');
            if(!list) return;
            list.innerHTML = '<li>Carregando ranking...</li>';

            let q;
            if (filter === 'general') {
                q = query(collection(db, "students"));
            } else {
                q = query(collection(db, "students"), where('turma', '==', filter));
            }

            const snapshot = await getDocs(q);
            if(snapshot.empty) {
                list.innerHTML = '<li>Nenhum dev no ranking ainda.</li>';
                return;
            }
            
            const sortedDocs = snapshot.docs.sort((a,b) => (b.data().totalXP || 0) - (a.data().totalXP || 0));

            list.innerHTML = sortedDocs.map((doc, index) => {
                const student = doc.data();
                const isCurrentUser = doc.id === currentStudentId;
                const highlightClass = isCurrentUser ? 'bg-cyan-500 bg-opacity-30' : '';
                return `
                    <li class="flex justify-between items-center p-2 rounded-lg ${highlightClass}">
                        <span>${index + 1}. ${student.name}</span>
                        <span class="font-bold text-lime-400">${student.totalXP || 0} XP</span>
                    </li>
                `;
            }).join('');
        }
        
        // --- Modal Rendering ---
        
        async function handleStudentModal(studentId = null) {
            let student = { name: '', matricula: '', turma: '' };
            if(studentId) {
                const docSnap = await getDoc(doc(db, 'students', studentId));
                student = docSnap.data();
            }
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-lime-400 mb-6">${studentId ? 'Editar' : 'Adicionar'} Dev</h3>
                        <form id="student-form" data-id="${studentId || ''}">
                            <div class="space-y-4">
                                <input type="text" id="student-name" placeholder="Nome Completo" required class="w-full bg-gray-800 rounded-lg p-2" value="${student.name}">
                                <input type="text" id="student-matricula" placeholder="Matrícula" required class="w-full bg-gray-800 rounded-lg p-2" value="${student.matricula}">
                                <input type="text" id="student-turma" placeholder="Turma" required class="w-full bg-gray-800 rounded-lg p-2" value="${student.turma}">
                            </div>
                            <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-2 px-6 rounded-lg">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }
        
        async function handleQuestModal(questId = null) {
            let quest = { title: '', description: '', difficulty: 'Fácil', maxXp: 100, turmas: [], endDate: '' };
            if (questId) {
                const docSnap = await getDoc(doc(db, 'quests', questId));
                quest = docSnap.data();
                quest.endDate = quest.endDate.toDate().toISOString().split('T')[0];
            }
            
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-fuchsia-400 mb-6">${questId ? 'Editar' : 'Criar'} Quest</h3>
                        <form id="quest-form" data-id="${questId || ''}" class="space-y-4">
                             <input id="quest-title" placeholder="Título da Quest" required class="w-full bg-gray-800 p-2 rounded-lg" value="${quest.title}">
                             <textarea id="quest-description" placeholder="Descrição" class="w-full bg-gray-800 p-2 rounded-lg">${quest.description}</textarea>
                             <div class="grid grid-cols-2 gap-4">
                                <select id="quest-difficulty" class="w-full bg-gray-800 p-2 rounded-lg">
                                    <option ${quest.difficulty === 'Fácil' ? 'selected' : ''}>Fácil</option>
                                    <option ${quest.difficulty === 'Médio' ? 'selected' : ''}>Médio</option>
                                    <option ${quest.difficulty === 'Difícil' ? 'selected' : ''}>Difícil</option>
                                </select>
                                <input id="quest-xp" type="number" placeholder="XP Máximo" required class="w-full bg-gray-800 p-2 rounded-lg" value="${quest.maxXp}">
                             </div>
                             <input id="quest-turmas" placeholder="Turmas (separadas por vírgula)" required class="w-full bg-gray-800 p-2 rounded-lg" value="${quest.turmas.join(', ')}">
                             <input id="quest-end-date" type="date" required class="w-full bg-gray-800 p-2 rounded-lg" value="${quest.endDate}">
                             <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold py-2 px-6 rounded-lg">Salvar Quest</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }

        async function handleGradingModal(questId) {
            const questDoc = await getDoc(doc(db, "quests", questId));
            if(!questDoc.exists()) return showAlert('Quest não encontrada!', 'error');
            const quest = questDoc.data();
            
            showModal(`<div class="modal-backdrop"><div class="modal-content glass-effect p-8 rounded-2xl"><p>Carregando alunos...</p></div></div>`);
            
            const studentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
            const studentsSnapshot = await getDocs(studentsQuery);
            const studentsInTurmas = studentsSnapshot.docs.filter(doc => quest.turmas.includes(doc.data().turma));

            const submissionsQuery = query(collection(db, "submissions"), where("questId", "==", questId));
            const submissionsSnapshot = await getDocs(submissionsQuery);
            const submissions = {};
            submissionsSnapshot.forEach(s => submissions[s.data().studentId] = s.data().score);

            const studentInputs = studentsInTurmas.map(sDoc => {
                const student = {id: sDoc.id, ...sDoc.data()};
                const score = submissions[student.id] || 0;
                return `
                    <div class="flex justify-between items-center bg-gray-800 p-2 rounded">
                        <label for="grade-${student.id}" class="text-gray-300">${student.name}</label>
                        <input id="grade-${student.id}" type="number" data-student-id="${student.id}" value="${score}" class="grade-input w-24 bg-gray-700 p-1 rounded text-center">
                    </div>
                `;
            }).join('');
            
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-game text-xl text-yellow-400">Lançar XP: ${quest.title}</h3>
                            <button id="import-grades-btn" data-quest-id="${questId}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm"><i class="fas fa-upload mr-2"></i>Importar Notas</button>
                        </div>
                        <form id="grading-form" data-quest-id="${questId}" class="space-y-3">
                            <div class="max-h-64 overflow-y-auto space-y-3 pr-2">
                                ${studentInputs || '<p>Nenhum aluno encontrado para as turmas desta Quest.</p>'}
                            </div>
                            <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-6 rounded-lg">Salvar Notas</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }

        function handleImportStudentModal() {
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-lime-400 mb-6">Importar Devs (Alunos)</h3>
                        <form id="import-student-form" class="space-y-4">
                            <p class="text-gray-300">Selecione um arquivo CSV com as colunas: <code class="bg-gray-900 p-1 rounded">nome,matricula,turma</code></p>
                            <a href="data:text/csv;charset=utf-8,nome,matricula,turma%0AJoao%20Silva,12345,2024A%0AMaria%20Souza,67890,2024B" download="template_alunos.csv" class="text-cyan-400 hover:underline">Descarregar modelo</a>
                            <input type="file" id="csv-file-students" accept=".csv" required class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                             <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-2 px-6 rounded-lg">Processar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }
        
        function handleImportQuestModal() {
             const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-fuchsia-400 mb-6">Importar Quests</h3>
                        <form id="import-quest-form" class="space-y-4">
                            <p class="text-gray-300">Selecione um CSV com as colunas: <code class="bg-gray-900 p-1 rounded">titulo,descricao,dificuldade,xp,turmas,prazo</code></p>
                            <p class="text-sm text-gray-400">Use ponto e vírgula (;) para separar múltiplas turmas. Prazo no formato AAAA-MM-DD.</p>
                            <a href="data:text/csv;charset=utf-8,titulo,descricao,dificuldade,xp,turmas,prazo%0AQuest%20Inicial,Fazer%20o%20setup,Facil,100,2024A;2024B,2025-12-31" download="template_quests.csv" class="text-cyan-400 hover:underline">Descarregar modelo</a>
                            <input type="file" id="csv-file-quests" accept=".csv" required class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                             <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold py-2 px-6 rounded-lg">Processar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }

        async function handleImportGradesModal(questId) {
            const questDoc = await getDoc(doc(db, "quests", questId));
            if (!questDoc.exists()) return showAlert('Quest não encontrada!', 'error');

            const studentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid), where("turma", "in", questDoc.data().turmas));
            const studentsSnapshot = await getDocs(studentsQuery);
            let csvContent = "matricula,xp_ganho\n";
            studentsSnapshot.docs.forEach(doc => {
                csvContent += `${doc.data().matricula},0\n`;
            });
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-blue-400 mb-6">Importar Notas para "${questDoc.data().title}"</h3>
                        <form id="import-grades-form" data-quest-id="${questId}" class="space-y-4">
                            <p class="text-gray-300">Selecione um arquivo CSV com as colunas: <code class="bg-gray-900 p-1 rounded">matricula,xp_ganho</code></p>
                            <a href="${encodedUri}" download="template_notas_${questId}.csv" class="text-cyan-400 hover:underline">Descarregar modelo com alunos da turma</a>
                            <input type="file" id="csv-file-grades" accept=".csv" required class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                            <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Processar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }

        async function handleEpicWorkModal(epicWorkId = null) {
            let epicWork = { questId: '', workLink: '', studentIds: [] };
            if (epicWorkId) {
                const docSnap = await getDoc(doc(db, 'epicWorks', epicWorkId));
                epicWork = docSnap.data();
            }

            const questsQuery = query(collection(db, "quests"), where("teacherId", "==", currentTeacher.uid));
            const questsSnapshot = await getDocs(questsQuery);
            const questsOptions = questsSnapshot.docs.map(doc => {
                const quest = { id: doc.id, ...doc.data() };
                const selected = quest.id === epicWork.questId ? 'selected' : '';
                return `<option value="${quest.id}" data-turmas='${JSON.stringify(quest.turmas)}' ${selected}>${quest.title}</option>`;
            }).join('');

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-purple-400 mb-6">${epicWorkId ? 'Editar' : 'Registrar'} Trabalho Épico</h3>
                        <form id="epic-work-form" data-id="${epicWorkId || ''}" class="space-y-4">
                            <div>
                                <label for="epic-quest-select" class="block mb-2 text-sm font-medium">Quest Associada</label>
                                <select id="epic-quest-select" required class="w-full bg-gray-800 p-2 rounded-lg">
                                    <option value="">-- Selecione uma Quest --</option>
                                    ${questsOptions}
                                </select>
                            </div>
                            <div>
                                <label for="epic-work-link" class="block mb-2 text-sm font-medium">Link para o Trabalho</label>
                                <input id="epic-work-link" type="url" placeholder="https://github.com/..." required class="w-full bg-gray-800 p-2 rounded-lg" value="${epicWork.workLink || ''}">
                            </div>
                            <div>
                                <label class="block mb-2 text-sm font-medium">Alunos Envolvidos</label>
                                <div id="epic-students-checkboxes" class="space-y-2 max-h-40 overflow-y-auto bg-gray-900 p-2 rounded-lg">
                                    <p class="text-gray-500">Selecione uma quest para ver os alunos.</p>
                                </div>
                            </div>
                             <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-6 rounded-lg">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);

            if (epicWorkId) {
                await populateEpicStudentsSelect(epicWork.questId, epicWork.studentIds);
            }
        }

        async function populateEpicStudentsSelect(questId, selectedStudentIds = []) {
            const container = document.getElementById('epic-students-checkboxes');
            if (!container) return;
            
            const questSelect = document.getElementById('epic-quest-select');
            const selectedOption = questSelect.options[questSelect.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.turmas) {
                container.innerHTML = '<p class="text-gray-500">Selecione uma quest válida.</p>';
                return;
            }
            const turmas = JSON.parse(selectedOption.dataset.turmas);

            if (turmas.length === 0) {
                container.innerHTML = '<p class="text-gray-500">Esta quest não está associada a nenhuma turma.</p>';
                return;
            }

            container.innerHTML = '<p class="text-gray-500">Carregando alunos...</p>';
            const studentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid), where("turma", "in", turmas));
            const studentsSnapshot = await getDocs(studentsQuery);

            if (studentsSnapshot.empty) {
                container.innerHTML = '<p class="text-gray-500">Nenhum aluno encontrado para a(s) turma(s) desta quest.</p>';
                return;
            }

            container.innerHTML = studentsSnapshot.docs.map(doc => {
                const student = { id: doc.id, ...doc.data() };
                const checked = selectedStudentIds.includes(student.id) ? 'checked' : '';
                return `
                    <label class="flex items-center space-x-3 p-2 hover:bg-gray-700 rounded-md">
                        <input type="checkbox" name="epic-students" value="${student.id}" data-name="${student.name}" class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded" ${checked}>
                        <span>${student.name}</span>
                    </label>
                `;
            }).join('');
        }

        function getGradeFeedback(grade) {
            if (grade >= 9.1) {
                return {
                    message: "Incrível! Um desempenho espetacular que inspira a todos. Parabéns!",
                    img: "https://i.imgur.com/hRYgJSi.webp?tb" // Galaxy Brain
                };
            } else if (grade >= 8.1) {
                return {
                    message: "Excelente trabalho! Você demonstrou um grande domínio e dedicação.",
                    img: "https://giving.virginia.edu/wp-content/uploads/2025/03/df35ac2237670621ad8aeab342f5b10d.jpg" // Drake approving
                };
            } else if (grade >= 7.1) {
                return {
                    message: "Muito bem! Um ótimo resultado, fruto do seu esforço e empenho.",
                    img: "https://i.imgur.com/eosuZ9w.jpeg" // Thumbs up kid
                };
            } else if (grade >= 6) {
                return {
                    message: "Na média! Você atingiu o objetivo. Continue assim para ir ainda mais longe!",
                    img: "https://i.imgur.com/O7ZxCGI_lq.mp4" // Salt Bae
                };
            } else if (grade >= 4.1) {
                return {
                    message: "Alerta! Este resultado está abaixo do esperado e a responsabilidade é sua. É preciso mais dedicação para reverter a situação.",
                    img: "https://i.imgur.com/rTgDovc.jpeg" // Disappointed Cricket Fan
                };
            } else if (grade >= 2.1) {
                return {
                    message: "Cuidado! Seu desempenho foi muito baixo. Reavalie seus métodos de estudo e assuma a responsabilidade pelo seu aprendizado.",
                    img: "https://i.imgur.com/SVGQ3eD_lq.mp4" // Panik
                };
            } else { // 0 to 2
                return {
                    message: "Resultado crítico. A responsabilidade é sua. É urgente uma mudança drástica de postura nos estudos para não ser reprovado.",
                    img: "https://i.imgur.com/c4jt321.png" // This is Fine
                };
            }
        }

        async function handleStudentPastResultsModal(studentId) {
            const q = query(collection(db, "pastResults"), where("studentId", "==", studentId));
            const snapshot = await getDocs(q);
            
            let resultsHTML = '<p class="text-gray-400">Nenhum resultado de período anterior encontrado.</p>';
            
            if (!snapshot.empty) {
                resultsHTML = snapshot.docs.map(doc => {
                    const result = doc.data();
                    const feedback = getGradeFeedback(result.grade);
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center bg-gray-800 p-4 rounded-lg">
                            <div>
                                <h4 class="font-bold text-lg text-cyan-300">${result.period}</h4>
                                <p class="font-game text-2xl text-lime-400 my-2">${result.grade.toFixed(1)}</p>
                                <p class="text-sm italic text-gray-300">"${feedback.message}"</p>
                            </div>
                            <img src="${feedback.img}" alt="${feedback.message}" class="rounded-lg w-full max-w-xs mx-auto">
                        </div>
                    `;
                }).join('<div class="my-2 border-b border-gray-700"></div>');
            }
            
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-indigo-400 mb-6">Histórico de Batalhas (Resultados)</h3>
                        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-4">
                            ${resultsHTML}
                        </div>
                         <div class="flex justify-end mt-8">
                            <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(modalHTML);
        }

        async function handlePastResultModal(resultId = null, studentIdForNew = null) {
            let result = { studentId: studentIdForNew || '', period: '', grade: ''};
            
            if (resultId) {
                const docSnap = await getDoc(doc(db, 'pastResults', resultId));
                if (docSnap.exists()) {
                    result = { id: docSnap.id, ...docSnap.data() };
                }
            }

            const studentsQuery = query(collection(db, "students"), where("teacherId", "==", currentTeacher.uid));
            const studentsSnapshot = await getDocs(studentsQuery);
            const sortedStudents = studentsSnapshot.docs.sort((a,b) => a.data().name.localeCompare(b.data().name));

            const studentOptions = sortedStudents.map(doc => {
                const student = { id: doc.id, ...doc.data() };
                const selected = student.id === result.studentId ? 'selected' : '';
                return `<option value="${student.id}" ${selected}>${student.name}</option>`;
            }).join('');

            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-lime-400 mb-6">${resultId ? 'Editar' : 'Adicionar'} Resultado Anterior</h3>
                        <form id="past-result-form" data-id="${resultId || ''}">
                            <div class="space-y-4">
                                <div>
                                    <label for="past-result-student-select" class="block mb-2 text-sm">Aluno</label>
                                    <select id="past-result-student-select" required class="w-full bg-gray-800 rounded-lg p-2">
                                        <option value="">-- Selecione um Aluno --</option>
                                        ${studentOptions}
                                    </select>
                                </div>
                                <div>
                                    <label for="past-result-period" class="block mb-2 text-sm">Período (ex: 2024/1)</label>
                                    <input type="text" id="past-result-period" placeholder="2024/1" required class="w-full bg-gray-800 rounded-lg p-2" value="${result.period}">
                                </div>
                                <div>
                                    <label for="past-result-grade" class="block mb-2 text-sm">Nota Final (0.0 a 10.0)</label>
                                    <input type="text" id="past-result-grade" placeholder="8.5" required class="w-full bg-gray-800 rounded-lg p-2" value="${result.grade}">
                                </div>
                            </div>
                            <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-lime-500 hover:bg-lime-600 text-gray-900 font-bold py-2 px-6 rounded-lg">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }

        function handleImportPastResultsModal() {
            const modalHTML = `
                <div class="modal-backdrop">
                    <div class="modal-content glass-effect p-8 rounded-2xl">
                        <h3 class="font-game text-xl text-blue-400 mb-6">Importar Resultados Anteriores</h3>
                        <form id="import-past-results-form" class="space-y-4">
                            <p class="text-gray-300">Selecione um arquivo CSV com as colunas: <code class="bg-gray-900 p-1 rounded">matricula,periodo,nota_final</code></p>
                            <a href="data:text/csv;charset=utf-8,matricula,periodo,nota_final%0A12345,2024/1,8.5%0A67890,2024/1,9.0" download="template_resultados.csv" class="text-cyan-400 hover:underline">Descarregar modelo</a>
                            <input type="file" id="csv-file-past-results" accept=".csv" required class="w-full text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                             <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="modal-close-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancelar</button>
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-lg">Processar</button>
                            </div>
                        </form>
                    </div>
                </div>`;
            showModal(modalHTML);
        }

        // --- Initial Load ---
        renderLoginView();

    </script>
</body>
</html>



